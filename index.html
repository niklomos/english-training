<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vocabulary Trainer ‚Äî Bootstrap 5 Responsive</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg1:#f6fbff; --bg2:#f1fff8; --card:#ffffff; --primary:#2563eb; --accent:#06b6d4; --muted:#6b7280; --success:#10b981; --danger:#ef4444; --radius:12px; --text:#0f172a;
    }
    /* dark theme variables */
    .dark{
      --bg1:#071427; --bg2:#0b1220; --card:#091422; --primary:#4f46e5; --accent:#06b6d4; --muted:#9aa6b2; --text:#e6eef8;
    }

    html,body{ height:100%; }
    body{ font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text); transition:background .25s ease,color .25s ease; }
    .logo{ width:56px; height:56px; border-radius:12px; background:var(--primary); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
    .card-custom{ border-radius:var(--radius); box-shadow:0 8px 26px rgba(2,6,23,0.06); background:var(--card); color:var(--text); transition:background .2s ease,color .2s ease; }
    .list-group-item{ background:var(--card); color:var(--text); }
    .btn-outline-secondary{ border-color:rgba(2,6,23,0.06); }
    .option.correct{ border-color:var(--success) !important; }
    .option.wrong{ border-color:var(--danger) !important; }
    .blank{ min-width:28px; padding:8px 10px; border-radius:8px; border:1px dashed #e6e9ef; font-weight:700; text-align:center; }
    .small-muted{ color:var(--muted); }
    @media (max-width:576px){ .logo{ width:48px; height:48px } }

    /* Make collapsed menu left-aligned on small screens */
    @media (max-width:991.98px){
      /* when the collapse is shown, stack nav items and align left */
      .navbar-collapse.show .navbar-nav{ flex-direction:column; align-items:flex-start; }
      .navbar-collapse .nav-link{ width:100%; text-align:left; padding-left:.5rem; }
      .navbar-collapse .nav-item{ width:100%; }
    }

    /* Dark-mode specific tweaks for navbar readability */
    .dark .navbar-brand, .dark .nav-link { color:var(--text) !important; }
    .dark .nav-link.active { background: rgba(255,255,255,0.06) !important; color:var(--text) !important; }
    .dark .logo{ /* slightly brighter border for contrast */ border:1px solid rgba(255,255,255,0.06); }
    .dark .navbar{ background: transparent; }

    /* theme toggle icon style */
    #themeToggle { min-width:42px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <nav class="navbar navbar-expand-lg bg-transparent mb-3">
      <div class="container-fluid p-0 align-items-center d-flex">
        <a class="navbar-brand d-flex align-items-center gap-3 me-2" href="#">
          <div class="logo me-2">VT</div>
          <div>
            <div class="h5 mb-0">Vocabulary Trainer</div>
          </div>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-end" id="mainNav">
          <ul class="navbar-nav nav-pills align-items-center">
            <li class="nav-item"><button class="nav-link active" data-tab="library">Library</button></li>
            <li class="nav-item"><button class="nav-link" data-tab="io">Import/Export</button></li>
            <li class="nav-item"><button class="nav-link" data-tab="practice">Practice</button></li>
            <li class="nav-item"><button class="nav-link" data-tab="quiz">Quiz</button></li>
            <li class="nav-item"><button class="nav-link" data-tab="stats">Stats</button></li>
            <li class="nav-item d-flex align-items-center ms-2">
              <!-- Theme toggle placed inside nav so it's reachable on small screens after toggling -->
              <button id="themeToggle" class="btn btn-outline-secondary" aria-pressed="false" title="Toggle theme">üåô</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- LIBRARY -->
    <section class="card card-custom mb-3 p-3" id="panel-library">
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="d-flex gap-2 flex-wrap mb-2">
            <input id="inputWord" type="text" class="form-control" placeholder="Word (EN)" style="min-width:140px">
            <input id="inputTrans" type="text" class="form-control" placeholder="Translation (TH)" style="min-width:140px">
            <button class="btn btn-primary" onclick="addWord()">Add</button>
          </div>

          <div class="d-flex gap-2 align-items-center mb-2">
            <input id="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="renderLibrary()">
            <select id="filter" class="form-select" style="width:160px" onchange="renderLibrary()">
              <option value="all">All</option>
              <option value="weak">Weak</option>
              <option value="mastered">Mastered</option>
            </select>
            <button class="btn btn-outline-secondary" onclick="renderLibrary()">Refresh</button>
          </div>

          <div class="list-group" id="list" style="max-height:520px; overflow:auto"></div>
        </div>

        <aside class="col-lg-4">
          <div class="d-flex flex-column gap-3">
            <div class="card p-2"><small class="small-muted">Total</small><div id="statTotal" class="h5 mb-0">0</div></div>
            <div class="card p-2"><small class="small-muted">Mastered (&ge;3)</small><div id="statMaster" class="h5 mb-0">0</div></div>
            <div class="card p-2"><small class="small-muted">Weak (&ge;2)</small><div id="statWeak" class="h5 mb-0">0</div></div>

            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary w-50" onclick="exportCSV()">Export CSV</button>
              <button class="btn btn-danger w-50" onclick="clearAll()">Clear</button>
            </div>

            <div>
              <div class="small-muted">Sample CSV (UTF-8)</div>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-outline-secondary" onclick="downloadSample()">Download</button>
                <input id="fileIn" type="file" accept=".csv" onchange="handleImportFile(event)" class="form-control">
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- remaining sections unchanged... -->

    <!-- IO -->
    <section class="card card-custom mb-3 p-3" id="panel-io" style="display:none">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="fw-bold">Import CSV</div>
          <div class="small-muted">Header: <code>Word,Translation</code> (UTF-8 recommended)</div>
          <input id="fileIn2" type="file" accept=".csv" onchange="handleImportFile(event)" class="form-control mt-2">
          <textarea id="pasteCsv" rows="8" class="form-control mt-2" placeholder="‡∏ß‡∏≤‡∏á CSV ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏°‡∏µ header)"></textarea>
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-primary" onclick="importFromPaste()">Import from paste</button>
            <button class="btn btn-outline-secondary" onclick="autoFixPaste()">Try auto-fix encoding</button>
          </div>
        </div>
        <div class="col-md-6">
          <div class="fw-bold">Export</div>
          <div class="small-muted">Export ‡πÄ‡∏õ‡πá‡∏ô UTF-8 + BOM (Excel friendly)</div>
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-outline-secondary" onclick="copyCSV()">Copy CSV</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PRACTICE -->
    <section class="card card-custom mb-3 p-3" id="panel-practice" style="display:none">
      <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
        <div class="fw-bold">Practice</div>
        <input id="pStart" type="number" class="form-control" placeholder="start (1)" style="width:110px">
        <input id="pEnd" type="number" class="form-control" placeholder="end" style="width:110px">
        <button class="btn btn-primary" onclick="startPractice()">Start</button>
        <button class="btn btn-outline-secondary" onclick="shufflePractice()">Shuffle</button>
        <button class="btn btn-outline-secondary" onclick="stopPractice()">Stop</button>
      </div>

      <div class="row g-3">
        <div class="col-lg-8">
          <div id="practiceCard" class="card p-3" style="display:none">
            <div class="h4" id="pWord">Word</div>
            <div class="text-muted" id="pTrans" style="display:none">Translation</div>
            <div class="mt-2 d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-primary" onclick="playEN('practice')">üîä EN</button>
              <button class="btn btn-outline-secondary" onclick="revealPractice()">Show</button>
              <button class="btn btn-success" onclick="markKnown()">‚úÖ Known</button>
              <button class="btn btn-danger" onclick="markWrong()">‚ùå Wrong</button>
              <button class="btn btn-outline-secondary" onclick="nextPractice()">Next</button>
            </div>
            <div class="mt-3">
              <div class="progress"><div id="pProgress" class="progress-bar" role="progressbar" style="width:0%"></div></div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="small-muted">Queue: <span id="pCount">0</span></div>
          <div class="small-muted">Index: <span id="pIndex">0</span></div>
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="practiceWeak()">Practice Weak</button>
            <button class="btn btn-outline-secondary" onclick="exportCSV()">Export</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section class="card card-custom mb-3 p-3" id="panel-quiz" style="display:none">
      <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
        <div class="fw-bold">Quiz (Multiple choice / Spelling / Random)</div>
        <input id="qStart" type="number" class="form-control" placeholder="start (1)" style="width:110px">
        <input id="qEnd" type="number" class="form-control" placeholder="end" style="width:110px">
        <label class="d-flex align-items-center gap-2 mb-0">Mode:
          <select id="qMode" class="form-select" style="width:240px">
            <option value="multiple">EN ‚Üí TH (Multiple choice)</option>
            <option value="reverse">TH ‚Üí EN (Reverse multiple choice)</option>
            <option value="spelling">Spelling (‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥‡πÄ‡∏õ‡πá‡∏ô EN)</option>
          </select>
        </label>
        <label class="d-flex align-items-center gap-2 mb-0"><input id="randomMode" type="checkbox"> Randomize per question</label>
        <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
        <label class="d-flex align-items-center gap-2 mb-0"><input id="autoNext" type="checkbox" checked> Auto next</label>
      </div>

      <div class="row g-3">
        <div class="col-lg-8">
          <div id="quizCard" class="card p-3" style="display:none; min-height:160px">
            <div class="h4" id="qWord">Word</div>
            <div class="small-muted" id="qCurrentMode"></div>
            <div class="mt-2"><button class="btn btn-outline-primary" onclick="playEN('quiz')">üîä EN</button></div>
            <div class="mt-2" id="qOptions"></div>

            <div id="spellingArea" style="display:none; width:100%; max-width:640px; text-align:center">
              <div class="h6 text-muted" id="qHint"></div>
              <div class="d-flex gap-2 justify-content-center flex-wrap" id="qBlanks"></div>
              <div class="d-flex gap-2 align-items-center mt-2">
                <input id="spellingInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (EN)" class="form-control" style="min-width:160px">
                <button class="btn btn-primary" onclick="submitSpelling()">Submit</button>
                <button class="btn btn-outline-secondary" onclick="revealSpelling()">Reveal</button>
              </div>
              <div id="spellingFeedback" class="small text-muted mt-2"></div>
            </div>

            <div class="mt-3">
              <div class="progress"><div id="qProgress" class="progress-bar" role="progressbar" style="width:0%"></div></div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card p-2 mb-2"><small class="small-muted">Score</small><div id="qScore" class="h6">0 / 0</div></div>
          <div class="small-muted">Wrong this session</div>
          <div id="sessionWrong" style="max-height:260px; overflow:auto; color:var(--muted)"></div>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section class="card card-custom mb-3 p-3" id="panel-stats" style="display:none">
      <div class="row g-3">
        <div class="col-md-8">
          <h5 class="mb-2">Weak words</h5>
          <div id="weakList"></div>
        </div>
        <div class="col-md-4">
          <div class="fw-bold">Details</div>
          <div class="mt-2">
            <div>Total: <b id="dTotal">0</b></div>
            <div>Mastered: <b id="dMaster">0</b></div>
            <div>Weak: <b id="dWeak">0</b></div>
            <div class="mt-2 d-flex gap-2"><button class="btn btn-outline-secondary" onclick="practiceWeak()">Practice Weak</button><button class="btn btn-outline-secondary" onclick="resetStats()">Reset Stats</button></div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Bootstrap Bundle JS (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Theme toggle script -->
  <script>
    const THEME_KEY = 'vt_theme';
    const themeToggle = document.getElementById('themeToggle');
    const navEl = document.querySelector('.navbar');
    function applyTheme(theme){
      if(theme === 'dark'){
        document.documentElement.classList.add('dark');
        navEl && navEl.classList.add('navbar-dark');
        navEl && navEl.classList.remove('navbar-light');
      } else {
        document.documentElement.classList.remove('dark');
        navEl && navEl.classList.remove('navbar-dark');
        navEl && navEl.classList.add('navbar-light');
      }
      // update button icon / aria
      if(theme === 'dark'){ themeToggle && (themeToggle.textContent = '‚òÄÔ∏è'); themeToggle && themeToggle.setAttribute('aria-pressed','true'); }
      else { themeToggle && (themeToggle.textContent = 'üåô'); themeToggle && themeToggle.setAttribute('aria-pressed','false'); }
      try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
    }
    function toggleTheme(){ const cur = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; applyTheme(cur === 'dark' ? 'light' : 'dark'); }
    // init on load
    (function(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved) applyTheme(saved);
      else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }
    })();
    themeToggle && themeToggle.addEventListener('click', toggleTheme);
  </script>

  <!-- Original app script (kept mostly intact) -->
  <script>
  /* ------------------------------
    Data model & storage
  -------------------------------*/
  const STORAGE_KEY = 'vocab_responsive_v1';
  let vocab = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(vocab)); updateStatsUI(); }
  function loadAll(){ vocab = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }

  /* ------------------------------
    Tab handling (uses data-tab attributes)
  -------------------------------*/
  document.querySelectorAll('.nav-link').forEach(t => {
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      document.querySelectorAll('[id^="panel-"]').forEach(p=>p.style.display='none');
      document.getElementById('panel-' + tab).style.display = 'block';
      refreshUI();
    });
  });

  /* ------------------------------
    Library functions
  -------------------------------*/
  function renderLibrary(){
    const list = document.getElementById('list'); list.innerHTML = '';
    const q = (document.getElementById('search').value || '').toLowerCase();
    const filter = document.getElementById('filter').value;
    let items = vocab.map((it,i)=>({...it, idx:i}));
    if(filter === 'weak') items = items.filter(i=> (i.wrong||0) >= 2);
    if(filter === 'mastered') items = items.filter(i=> (i.correct||0) >= 3);
    if(q) items = items.filter(i => (i.word + ' ' + i.translation).toLowerCase().includes(q));
    if(!items.length){ list.innerHTML = '<div class="small small-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</div>'; return; }
    items.forEach(it=>{
      const el = document.createElement('div'); el.className = 'list-group-item d-flex justify-content-between align-items-center';
      el.innerHTML = `<div class="d-flex gap-3 align-items-center"><div class="badge bg-light text-muted" style="min-width:44px;text-align:center">${it.idx+1}</div><div><div class="fw-bold">${escapeHtml(it.word)}</div><div class="small text-muted">${escapeHtml(it.translation)}</div><div class="small">‚úÖ ${it.correct||0} ‚ùå ${it.wrong||0}</div></div></div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-outline-secondary btn-sm" onclick="playENIndex(${it.idx})">üîä</button>
          <button class="btn btn-outline-primary btn-sm" onclick="editItem(${it.idx})">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteItem(${it.idx})">üóë</button>
        </div>`;
      list.appendChild(el);
    });
  }
  function addWord(){
    const w = document.getElementById('inputWord').value.trim();
    const t = document.getElementById('inputTrans').value.trim();
    if(!w || !t) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Word ‡πÅ‡∏•‡∏∞ Translation');
    vocab.push({word:w, translation:t, correct:0, wrong:0, lastSeen: Date.now()});
    document.getElementById('inputWord').value=''; document.getElementById('inputTrans').value='';
    saveAll(); renderLibrary();
  }
  function editItem(i){
    const it = vocab[i];
    const nw = prompt('‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå', it.word); if(nw===null) return;
    const nt = prompt('‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•', it.translation); if(nt===null) return;
    it.word = nw.trim(); it.translation = nt.trim(); it.lastSeen = Date.now(); saveAll(); renderLibrary();
  }
  function deleteItem(i){ if(!confirm('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå?')) return; vocab.splice(i,1); saveAll(); renderLibrary(); }
  function clearAll(){ if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return; vocab = []; saveAll(); renderLibrary(); }

  /* ------------------------------
    Import / Export CSV
  -------------------------------*/
  function handleImportFile(e){
    const f = e.target.files[0]; if(!f) return;
    Papa.parse(f, { header:true, skipEmptyLines:true, complete(results){
      const rows = results.data; const items=[];
      for(const r of rows){
        const W = r.Word ?? r.word ?? Object.values(r)[0];
        const T = r.Translation ?? r.translation ?? Object.values(r)[1];
        if(!W || !T) continue;
        items.push({word:String(W).trim(), translation:String(T).trim(), correct:0, wrong:0, lastSeen: Date.now()});
      }
      if(!items.length) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
      vocab = items; saveAll(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ' + items.length + ' ‡∏Ñ‡∏≥'); renderLibrary();
    }, error(err){ alert('Import failed: '+err.message); }});
  }
  function importFromPaste(){
    const txt = document.getElementById('pasteCsv').value.trim(); if(!txt) return alert('‡∏ß‡∏≤‡∏á CSV ‡∏Å‡πà‡∏≠‡∏ô');
    const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true }); const rows = parsed.data; const items=[];
    for(const r of rows){
      const W = r.Word ?? r.word ?? Object.values(r)[0];
      const T = r.Translation ?? r.translation ?? Object.values(r)[1];
      if(!W || !T) continue;
      items.push({word:String(W).trim(), translation:String(T).trim(), correct:0, wrong:0, lastSeen: Date.now()});
    }
    if(!items.length) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á');
    vocab = items; saveAll(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ' + items.length + ' ‡∏Ñ‡∏≥'); renderLibrary();
  }
  function autoFixPaste(){
    const txt = document.getElementById('pasteCsv').value;
    if(!txt) return alert('‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô');
    try{
      if(/%[0-9A-F]{2}/i.test(txt)){ document.getElementById('pasteCsv').value = decodeURIComponent(txt); alert('decodeURIComponent applied'); return; }
      document.getElementById('pasteCsv').value = decodeURIComponent(escape(txt)); alert('attempted latin1->utf8 conversion');
    }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ'); }
  }
  function exportCSV(){
    if(!vocab.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå');
    const rows = vocab.map(i=>({Word:i.word, Translation:i.translation}));
    const csv = Papa.unparse(rows);
    const blob = new Blob(['Ôªø' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'vocabulary.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  async function copyCSV(){
    if(!vocab.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå');
    const rows = vocab.map(i=>({Word:i.word, Translation:i.translation}));
    const csv = Papa.unparse(rows);
    try{ await navigator.clipboard.writeText(csv); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } catch(e){ alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); }
  }
  function downloadSample(){
    const sample = `Word,Translation
  apple,‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•
  banana,‡∏Å‡∏•‡πâ‡∏ß‡∏¢
  cat,‡πÅ‡∏°‡∏ß
  dog,‡∏™‡∏∏‡∏ô‡∏±‡∏Ç
  elephant,‡∏ä‡πâ‡∏≤‡∏á
  fish,‡∏õ‡∏•‡∏≤
  grape,‡∏≠‡∏á‡∏∏‡πà‡∏ô
  house,‡∏ö‡πâ‡∏≤‡∏ô
  ice,‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á
  juice,‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ
  kite,‡∏ß‡πà‡∏≤‡∏ß
  lion,‡∏™‡∏¥‡∏á‡πÇ‡∏ï
  monkey,‡∏•‡∏¥‡∏á
  notebook,‡∏™‡∏°‡∏∏‡∏î
  orange,‡∏™‡πâ‡∏°
  pen,‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤
  queen,‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ
  rabbit,‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢
  sun,‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
  tree,‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ
  umbrella,‡∏£‡πà‡∏°
  violet,‡∏°‡πà‡∏ß‡∏á
  water,‡∏ô‡πâ‡∏≥
  xylophone,‡πÑ‡∏ã‡πÇ‡∏•‡πÇ‡∏ü‡∏ô
  yellow,‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
  zebra,‡∏°‡πâ‡∏≤‡∏•‡∏≤‡∏¢
  car,‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå
  book,‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
  chair,‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ
  table,‡πÇ‡∏ï‡πä‡∏∞`;
    const blob = new Blob(['Ôªø' + sample], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'vocab-sample-30.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* ------------------------------
    Practice (flashcards)
  -------------------------------*/
  let practiceQueue = [], practiceIndex = 0;
  function startPractice(){
    if(!vocab.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå');
    const s = parseInt(document.getElementById('pStart').value) || 1;
    const e = parseInt(document.getElementById('pEnd').value) || vocab.length;
    const start = Math.max(1, s) - 1, end = Math.min(vocab.length, e);
    if(start >= end) return alert('‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    practiceQueue = [];
    for(let i = start; i < end; i++) practiceQueue.push(i);
    practiceIndex = 0;
    document.getElementById('practiceCard').style.display = 'block';
    showPracticeCard();
  }
  function showPracticeCard(){
    if(!practiceQueue.length) return;
    if(practiceIndex >= practiceQueue.length) practiceIndex = 0;
    const idx = practiceQueue[practiceIndex];
    const it = vocab[idx];
    document.getElementById('pWord').textContent = it.word;
    document.getElementById('pTrans').textContent = it.translation;
    document.getElementById('pTrans').style.display = 'none';
    document.getElementById('practiceCard').dataset.idx = idx;
    document.getElementById('pCount').textContent = practiceQueue.length;
    document.getElementById('pIndex').textContent = (practiceIndex + 1) + ' / ' + practiceQueue.length;
    const pct = Math.round(((practiceIndex + 1) / practiceQueue.length) * 100);
    document.getElementById('pProgress').style.width = pct + '%';
  }
  function revealPractice(){ document.getElementById('pTrans').style.display = 'block'; }
  function nextPractice(){ practiceIndex++; if(practiceIndex >= practiceQueue.length) practiceIndex = 0; showPracticeCard(); }
  function shufflePractice(){ for(let i = practiceQueue.length - 1; i > 0; i--){ const j = Math.floor(Math.random() * (i + 1)); [practiceQueue[i], practiceQueue[j]] = [practiceQueue[j], practiceQueue[i]] } practiceIndex = 0; showPracticeCard(); }
  function markKnown(){ const idx = parseInt(document.getElementById('practiceCard').dataset.idx || -1); if(idx < 0) return; vocab[idx].correct = (vocab[idx].correct || 0) + 1; vocab[idx].lastSeen = Date.now(); saveAll(); nextPractice(); }
  function markWrong(){ const idx = parseInt(document.getElementById('practiceCard').dataset.idx || -1); if(idx < 0) return; vocab[idx].wrong = (vocab[idx].wrong || 0) + 1; vocab[idx].lastSeen = Date.now(); saveAll(); nextPractice(); }
  function stopPractice(){ document.getElementById('practiceCard').style.display = 'none'; }
  function practiceWeak(){ const weak = vocab.map((it,i)=>({it,i})).filter(x=> (x.it.wrong||0) >= 2).map(x=>x.i); if(!weak.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢'); practiceQueue = weak; practiceIndex = 0; document.getElementById('practiceCard').style.display = 'block'; showPracticeCard(); }

  /* ------------------------------
    Quiz (multiple choice + spelling + reverse + random per question)
  -------------------------------*/
  let quizQueue = [], quizScore = 0, quizTotal = 0, quizCurrent = null, sessionWrong = [], quizRandomize = false;
  function startQuiz(){
    if(!vocab.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå');
    const s = parseInt(document.getElementById('qStart').value) || 1;
    const e = parseInt(document.getElementById('qEnd').value) || vocab.length;
    const start = Math.max(1, s) - 1, end = Math.min(vocab.length, e);
    if(start >= end) return alert('‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    quizRandomize = document.getElementById('randomMode').checked;
    const fixedMode = document.getElementById('qMode').value;
    quizQueue = [];
    for(let i = start; i < end; i++) quizQueue.push(i);
    shuffleArray(quizQueue);
    quizTotal = quizQueue.length; quizScore = 0; sessionWrong = [];
    document.getElementById('qScore').textContent = `${quizScore} / ${quizTotal}`;
    document.getElementById('quizCard').style.display = 'block';
    document.getElementById('spellingArea').style.display = 'none';
    showNextQuiz(quizRandomize ? null : fixedMode);
  }

  function showNextQuiz(mode){
    if(!quizQueue.length){
      alert(`‡∏à‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${quizScore} / ${quizTotal}`);
      renderSessionWrong(); return;
    }
    const idx = quizQueue.pop();
    const it = vocab[idx];
    let chosenMode = mode;
    if(quizRandomize || !chosenMode){
      const modes = ['multiple','reverse','spelling'];
      chosenMode = modes[Math.floor(Math.random()*modes.length)];
    }
    quizCurrent = { idx, item: it, mode: chosenMode };
    const modeLabel = chosenMode === 'multiple' ? 'EN ‚Üí TH' : chosenMode === 'reverse' ? 'TH ‚Üí EN' : 'Spelling (EN)';
    document.getElementById('qCurrentMode').textContent = `Mode: ${modeLabel}`;

    if(chosenMode === 'spelling'){
      renderSpelling(quizCurrent);
    } else if(chosenMode === 'reverse'){
      const options = [it.word];
      const pool = vocab.map(v=>v.word).filter(w=> w !== it.word);
      shuffleArray(pool);
      for(let i=0;i<pool.length && options.length<4;i++){ if(!options.includes(pool[i])) options.push(pool[i]); }
      while(options.length<4) options.push('(no option)'); shuffleArray(options);
      quizCurrent.options = options; renderReverse(quizCurrent);
    } else {
      const options = [it.translation];
      const pool = vocab.map(v=>v.translation).filter(t=> t !== it.translation);
      shuffleArray(pool);
      for(let i=0;i<pool.length && options.length<4;i++){ if(!options.includes(pool[i])) options.push(pool[i]); }
      while(options.length<4) options.push('(no option)'); shuffleArray(options);
      quizCurrent.options = options; renderQuiz(quizCurrent);
    }
  }

  function renderQuiz(q){
    document.getElementById('qWord').textContent = q.item.word;
    document.getElementById('qHint').textContent = '';
    document.getElementById('spellingArea').style.display = 'none';
    const optsEl = document.getElementById('qOptions'); optsEl.innerHTML = '';
    q.options.forEach(opt=>{
      const d = document.createElement('button'); d.className = 'btn btn-outline-secondary d-block mb-2 option'; d.textContent = opt;
      d.onclick = ()=> evaluateQuiz(opt, q.item.translation, q.idx, d);
      optsEl.appendChild(d);
    });
    const done = quizTotal - quizQueue.length; const pct = Math.round((done/quizTotal)*100);
    document.getElementById('qProgress').style.width = pct + '%';
  }

  function renderReverse(q){
    document.getElementById('qWord').textContent = q.item.translation;
    document.getElementById('spellingArea').style.display = 'none';
    const optsEl = document.getElementById('qOptions'); optsEl.innerHTML = '';
    q.options.forEach(opt=>{
      const d = document.createElement('button'); d.className = 'btn btn-outline-secondary d-block mb-2 option'; d.textContent = opt;
      d.onclick = ()=> evaluateQuiz(opt, q.item.word, q.idx, d);
      optsEl.appendChild(d);
    });
    const done = quizTotal - quizQueue.length; const pct = Math.round((done/quizTotal)*100);
    document.getElementById('qProgress').style.width = pct + '%';
  }

  function renderSpelling(q){
    document.getElementById('qWord').textContent = '';
    document.getElementById('qHint').textContent = q.item.translation;
    document.getElementById('qBlanks').innerHTML = '';
    document.getElementById('spellingInput').value = '';
    document.getElementById('spellingFeedback').textContent = '';
    document.getElementById('spellingArea').style.display = 'block';
    document.getElementById('qOptions').innerHTML = '';
    const word = q.item.word;
    const revealCount = Math.min(2, Math.floor(word.length/4));
    const revealPositions = new Set();
    while(revealPositions.size < revealCount){ revealPositions.add(Math.floor(Math.random()*word.length)); }
    for(let i=0;i<word.length;i++){
      const ch = word[i];
      const span = document.createElement('div'); span.className='blank me-1';
      span.textContent = revealPositions.has(i) ? ch : '_';
      document.getElementById('qBlanks').appendChild(span);
    }
    const done = quizTotal - quizQueue.length; const pct = Math.round((done/quizTotal)*100);
    document.getElementById('qProgress').style.width = pct + '%';
    setTimeout(()=> document.getElementById('spellingInput').focus(), 60);
  }

  function submitSpelling(){ if(!quizCurrent) return; const input = document.getElementById('spellingInput').value.trim(); const correct = quizCurrent.item.word; evaluateSpelling(input, correct, quizCurrent.idx); }
  function revealSpelling(){ if(!quizCurrent) return; document.getElementById('spellingFeedback').textContent = `‡πÄ‡∏â‡∏•‡∏¢: ${quizCurrent.item.word}`; vocab[quizCurrent.idx].wrong = (vocab[quizCurrent.idx].wrong||0) + 1; vocab[quizCurrent.idx].lastSeen = Date.now(); saveAll(); sessionWrong.push({ idx: quizCurrent.idx, word: vocab[quizCurrent.idx].word, correct: vocab[quizCurrent.idx].translation }); updateSessionWrong(); const auto = document.getElementById('autoNext').checked; if(auto) setTimeout(()=> showNextQuiz(null), 900); }

  function evaluateSpelling(input, correct, idx){ document.getElementById('spellingInput').disabled = true; const auto = document.getElementById('autoNext').checked; if(input.toLowerCase() === correct.toLowerCase()){ document.getElementById('spellingFeedback').textContent = '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'; vocab[idx].correct = (vocab[idx].correct||0) + 1; quizScore++; } else { document.getElementById('spellingFeedback').textContent = `‡∏ú‡∏¥‡∏î ‚Äî ‡πÄ‡∏â‡∏•‡∏¢: ${correct}`; vocab[idx].wrong = (vocab[idx].wrong||0) + 1; sessionWrong.push({ idx, word: vocab[idx].word, correct: vocab[idx].translation }); } vocab[idx].lastSeen = Date.now(); saveAll(); document.getElementById('qScore').textContent = `${quizScore} / ${quizTotal}`; updateSessionWrong(); if(auto){ setTimeout(()=> { document.getElementById('spellingInput').disabled = false; showNextQuiz(null); }, 900); } else { setTimeout(()=> { document.getElementById('spellingInput').disabled = false; }, 250); } }

  function evaluateQuiz(selected, correct, idx, el){ document.querySelectorAll('#qOptions .option').forEach(o=>o.onclick = null); const auto = document.getElementById('autoNext').checked; if(selected === correct){ el.classList.add('correct'); quizScore++; vocab[idx].correct = (vocab[idx].correct || 0) + 1; } else { el.classList.add('wrong'); vocab[idx].wrong = (vocab[idx].wrong||0) + 1; document.querySelectorAll('#qOptions .option').forEach(o=>{ if(o.textContent === correct) o.classList.add('correct'); }); sessionWrong.push({ idx, word: vocab[idx].word, correct: vocab[idx].translation }); } vocab[idx].lastSeen = Date.now(); saveAll(); document.getElementById('qScore').textContent = `${quizScore} / ${quizTotal}`; updateSessionWrong(); if(auto){ setTimeout(()=> showNextQuiz(null), 700); } else { const nextBtn = document.createElement('button'); nextBtn.textContent = 'Next'; nextBtn.className = 'btn btn-outline-primary mt-2'; nextBtn.onclick = ()=> { nextBtn.remove(); showNextQuiz(null); }; document.getElementById('qOptions').appendChild(nextBtn); } }

  function updateSessionWrong(){ const el = document.getElementById('sessionWrong'); el.innerHTML = ''; sessionWrong.forEach(w=>{ const d = document.createElement('div'); d.textContent = `${w.word} ‚Üí ${w.correct}`; el.appendChild(d); }); }
  function renderSessionWrong(){ updateSessionWrong(); }

  function retryWrong(){ const wrongIdx = vocab.map((it,i)=>({it,i})).filter(x=> (x.it.wrong||0) >= 1).map(x=>x.i); if(!wrongIdx.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢'); quizQueue = [...wrongIdx]; shuffleArray(quizQueue); quizTotal = quizQueue.length; quizScore = 0; sessionWrong = []; document.getElementById('qScore').textContent = `${quizScore} / ${quizTotal}`; document.getElementById('quizCard').style.display = 'block'; showNextQuiz(document.getElementById('qMode').value); }

  /* ------------------------------
    Audio (EN TTS only)
  -------------------------------*/
  let enVoice = null; function initVoices(){ const voices = speechSynthesis.getVoices(); enVoice = voices.find(v => v.lang && v.lang.startsWith('en')) || null; } speechSynthesis.onvoiceschanged = initVoices; initVoices();
  function playEN(mode){ let text = null; if(mode === 'practice'){ const idx = parseInt(document.getElementById('practiceCard').dataset.idx || -1); if(idx >= 0) text = vocab[idx].word; } else if(mode === 'quiz'){ if(quizCurrent && quizCurrent.item) text = quizCurrent.item.word; } else if(typeof mode === 'number'){ text = vocab[mode].word; } if(!text) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; if(enVoice) u.voice = enVoice; speechSynthesis.speak(u); }
  function playENIndex(i){ playEN(i); }

  /* ------------------------------
    Stats & helpers
  -------------------------------*/
  function updateStatsUI(){ document.getElementById('statTotal').textContent = vocab.length; document.getElementById('statMaster').textContent = vocab.filter(i=> (i.correct||0) >= 3).length; document.getElementById('statWeak').textContent = vocab.filter(i=> (i.wrong||0) >= 2).length; document.getElementById('dTotal').textContent = vocab.length; document.getElementById('dMaster').textContent = vocab.filter(i=> (i.correct||0) >= 3).length; document.getElementById('dWeak').textContent = vocab.filter(i=> (i.wrong||0) >= 2).length; renderWeakList(); }
  function renderWeakList(){ const el = document.getElementById('weakList'); el.innerHTML = ''; const weak = vocab.map((it,i)=>({...it,i})).filter(x=> (x.wrong||0) >= 2).sort((a,b)=> (b.wrong||0) - (a.wrong||0)); weak.forEach(w=>{ const div = document.createElement('div'); div.className = 'list-group-item d-flex justify-content-between align-items-center'; div.innerHTML = `<div class="d-flex gap-3 align-items-center"><div class="badge bg-light text-muted" style="min-width:44px;text-align:center">${w.i+1}</div><div><div class="fw-bold">${escapeHtml(w.word)}</div><div class="small text-muted">${escapeHtml(w.translation)}</div><div class="small">Wrong: ${w.wrong||0}</div></div></div>
        <div class="d-flex gap-2"><button class="btn btn-primary btn-sm" onclick="practiceSingle(${w.i})">Practice</button><button class="btn btn-outline-secondary btn-sm" onclick="editItem(${w.i})">Edit</button></div>`; el.appendChild(div); }); }
  function practiceSingle(i){ practiceQueue = [i]; practiceIndex = 0; document.getElementById('practiceCard').style.display = 'block'; showPracticeCard(); }
  function resetStats(){ if(!confirm('Reset stats?')) return; vocab.forEach(i=>{ i.correct=0; i.wrong=0; }); saveAll(); updateStatsUI(); alert('Reset done'); }
  function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  /* ------------------------------
    Init / UI helpers
  -------------------------------*/
  function refreshUI(){ renderLibrary(); updateStatsUI(); updateSessionWrong(); }
  window.addEventListener('beforeunload', ()=> saveAll()); renderLibrary(); updateStatsUI();
  </script>
</body>
</html>
